---
title: 'Fitting Integrated Population Models to Lower Columbia River Chum Salmon Monitoring Data'
author: "Eric Buhle, Kale Bentley, Thomas Buehrens, Mark Scheuerell, Todd Hillson, and ..."
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: cerulean
    df_print: paged
    fig_caption: true
    toc: true
    toc_float: true
  word_document:
    toc: true
  pdf_document:
    highlight: haddock
    toc: yes
    number_sections: true
    toc_depth: '3'
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE, highlight = TRUE, comment = NA, 
                      dev = "png", dev.args = list(type = "cairo-png"), dpi = 200,
                      out.width = "50%", fig.align = "center")

library(here) 
if(!require(captioner))
  devtools::install_github("adletaw/captioner")
library(captioner)
fig_nums <- captioner("Figure ", suffix = ": ", auto_space = FALSE, style = "b", style_prefix = TRUE)
library(kableExtra)
```

```{r width, include=FALSE}
options(width = 130)
```

```{r read_chunks, echo = FALSE}
knitr::read_chunk(here("analysis","R","02_LCRchumIPM_analysis.R"))
```

```{r getting_started, echo=FALSE, message = FALSE, warning = FALSE}
```

```{r data, echo=FALSE, warning = FALSE, message = FALSE}
```

# Background

Historically, hundreds of thousands of chum salmon (*Oncorhynchus keta*) adults returned annually to the Lower Columbia River (LCR). However, much like other salmon populations throughout the Pacific Northwest, the overall abundance of LCR chum has declined precipitously as a result of anthropogenic impacts and climatic changes. In 1999, Columbia River chum salmon were listed as Threatened under the Endangered Species Act (ESA), prompting state and federal agencies to begin recovery efforts. Specifically, the Washington Department of Fish and Wildlife (WDFW) began implementing a chum recovery program that uses a three-pronged approach, which includes habitat restoration, hatchery supplementation, and monitoring and evaluation. Each of these prongs has been implemented for 15–20 years, but the resulting data sets have not previously been directly integrated to understand the patterns and drivers of temporal and spatial variability in chum abundance and productivity.

In 2016, WDFW proposed the development of a life-cycle model (LCM) to improve our understanding of LCR chum population dynamics and to provide a platform for future analyses that could: (1) help identify limiting life stages through time and space, (2) help identify criteria to assess the need for supplementation, and (3) help prioritize habitat restoration by identifying the features of viable chum habitat patches. 

We will estimate the parameters in a stage-structured, multi-population LCM for Lower Columbia chum by casting it as an integrated population model (IPM), in which a joint likelihood function allows the model to be fitted to all available data at once. IPMs are the state-of-the-art framework for parameterizing structured population models and have been used widely in fisheries and wildlife because they offer numerous advantages over an ad hoc, piecemeal approach, especially when data are sparse or heterogeneous. The heart of an IPM is a state-space model, which distinguishes true ecological process variation from observation noise, reducing bias in estimates of density-dependence and extinction risk. 
Specifically, we will build on the R package salmonIPM developed by NOAA and Biomark, which facilitates fitting a variety of age- and stage-structured IPMs tailored to anadromous salmonid life histories. Using this platform will allow a reproducible workflow from data to model-fitting and management scenario analysis, which can be easily updated as new data become available. 

Existing functionality in salmonIPM includes multi-population, age-structured spawner-to-spawner models (see Figures 1 & 2) as well as two-stage spawner-smolt models. As a starting point for the Lower Columbia chum work, these models can already address many of WDFW’s objectives, such as characterizing spatiotemporal variation in freshwater productivity and marine survival, short-term forecasting, and long-term population viability analysis (PVA). These generic models will serve as building blocks for a more detailed, bespoke model for Lower Columbia chum that includes sex, age-specific fecundity, sample-based estimates of observation errors, hatchery operations, and habitat and environmental drivers of stage-specific vital rates. The fitted model will be used to identify stage- and location-specific bottlenecks limiting viability at the population and ESU level. Beyond the present scope of work, this model will also lend itself naturally to scenario analyses aimed at questions such as monitoring design (e.g., data gaps and value of specific data types relative to their cost); prioritization of habitat restoration; effectiveness of supplementation; and potential rates of recolonization.

# Model Structure

## Process Model

### Egg Deposition and Egg-to-Smolt Survival

The chum life cycle begins with spawning, egg incubation and fry emergence, and shortly thereafter the downstream migration of juveniles (which we refer to as smolts). In **salmonIPM** we can fit three alternative spawner-recruit functions to describe the expected relationship between spawner abundance $S_{jt}$ and smolt abundance $M_{jt}$ in brood year $t$ in population $j$: density-independent discrete exponential, Beverton-Holt, and Ricker:

$$
f \left( S_{jt} | \alpha_{jt}, M_{\text{max},j}, A_{jt} \right) = 
\begin{cases}
\alpha_{jt} S_{jt} & \text{exponential} 
\\
\dfrac{ \alpha_{jt} S_{jt} }{ 1 + \dfrac{ \alpha_{jt} S_{jt} }{ A_{jt} M_{\text{max},j} }} 
& \text{Beverton-Holt} 
\\
\alpha_{jt} S_{jt} \text{exp}\left(- \dfrac{ \alpha_{jt}S_{jt} }{ \text{exp}(1) A_{jt} M_{\text{max},j} } \right) & \text{Ricker}
\end{cases}
$$

We use a nonstandard parameterization of the Ricker in terms of maximum smolt production or "capacity" $M_{\text{max}}$, corresponding to the mode of the function. This facilitates direct comparison with the Beverton-Holt (where $M_{\text{max}}$ is the asymptote) and is better-identified by data than the standard parameterization based on per capita density dependence. $M_{\text{max}}$ has units of density (fish per stream distance or area) and is then expanded to units of abundance based on habitat size $A_{jt}$. In the case of Lower Columbia chum, this is km of spawning habitat estimated using GIS.

Intrinsic productivity $\alpha_{jt}$ is calculated as a weighted mean of age-specific female fecundity $\mu_{E,a}$, weighted by the spawner age distribution $q_{jta}$, multiplied by the proportion of female spawners $q_{\text{F},jt}$ (discounted for the proportion of females that are not "green", i.e. not fully fecund, with discount rate $\delta_\text{NG} \in [0,1]$), and finally multiplied by the density-independent maximum egg-to-smolt survival $\psi_j$:

$$ 
\alpha_{jt} = \psi_j q_{F,jt} 
\left[p_{\text{G},jt} + \delta_\text{NG} \left(1 - p_{\text{G},jt} \right) \right] 
\sum_{a=3}^{5} q_{jta} \mu_{E,a}.
$$

The discount for partially spawned females is only relevant for one population, Duncan Channel, a constructed spawning channel in which some translocated females are believed to have already deposited eggs elsewhere. We assume the proportion of "green" females $p_{\text{G},jt}$ is known without error since translocated spawners are individually handled and visually assessed.

This formulation implicitly assumes egg deposition is density-independent while egg-to-smolt survival is density-dependent, resulting in realized survival $< \psi_j$ as spawner density increases. Maximum egg-to-smolt survival varies randomly among populations according to the hyperdistribution

$$
\text{logit}(\psi_j) \sim N(\mu_\psi, \sigma_\psi).
$$

Maximum smolt production varies randomly among populations according to the hyperdistribution

$$
\text{log}(M_{\text{max},j}) \sim 
N(\mu_{M_\text{max}}, \sigma_{M_\text{max}}).
$$

### Smolt Recruitment Process Error

Given the expected smolt production, realized smolt production (the unknown "true state") is lognormally distributed with process errors that include a common ESU-level autoregressive trend $\eta^\text{year}_{M,t}$ with first-order autocorrelation coefficient $\rho_{M}$ and innovation SD $\sigma^\text{year}_{M}$, plus unique independent shocks $\epsilon_{M,jt}$:

$$
\begin{aligned}
M_{jt} &= f \left( S_{jt} | \alpha_{jt}, M_{\text{max},j}, A_{jt} \right) \, 
\text{exp}( \eta^\text{year}_{M,t} + \epsilon_{M,jt} )
\\
\eta^\text{year}_{M,t} &\sim N(\rho_{M} \eta^\text{year}_{M,t-1}, \sigma^\text{year}_{M}) 
\\
\epsilon_{M,jt} &\sim N(0, \sigma_{M}).
\end{aligned}
$$

In **salmonIPM** we can include covariates of the parameters $\psi_j$ and $M_{\text{max},j}$ as well as the smolt recruitment process error term. We do not consider this option further here, but we anticipate incorporating environmental covariates in future development of the Lower Columbia chum IPM.

### Smolt-to-Adult Survival

Smolt-to-adult survival (SAR, $s_{MS}$) is assumed to be density-independent. The SAR process model for outmigrant cohort $t$ in population $j$ is logistic normal, including a common ESU-level first-order autoregressive trend $\eta^\text{year}_{MS,t}$ with first-order autocorrelation coefficient $\rho_{MS}$ and innovation SD $\sigma^\text{year}_{MS}$, plus unique independent shocks $\epsilon_{MS,jt}$:

$$
\begin{aligned}
\text{logit}( s_{MS,jt} ) &= \text{logit}( \mu_{MS} ) + 
\eta^\text{year}_{MS,t} + \epsilon_{MS,jt} 
\\
\eta^\text{year}_{MS,t} &\sim 
N(\rho_{MS} \eta^\text{year}_{MS,t-1}, \sigma^\text{year}_{MS}) 
\\
\epsilon_{MS,jt} &\sim N(0, \sigma_{MS}).
\end{aligned}
$$
As with the smolt recruitment parameters, **salmonIPM** can accommodate spatiotemporally varying covariates of $s_{MS}$, but we do not discuss this further here. 


### Conditional Age-at-Return

Adult age structure is modeled by defining a vector of conditional probabilities,
$\mathbf{p}_{jt} = [p_{3jt}, p_{4jt}, p_{5jt}] ^ \top$, where $p_{ajt}$ is the probability that an outmigrant in year $t$ in population $j$ returns at age $a$, given that it survives to adulthood. The unconditional probability is given by $s_{MS,jt} p_{ajt}$, where both SAR and $p_a$ are functions of underlying annual marine survival and maturation probabilities that are nonidentifiable without some ancillary data. This parameterization resolves the nonidentifiability.

The conditional age probabilities follow a logistic normal process model with hierarchical structure across populations and through time within each population. The additive log ratio,

$$
\text{alr}(\mathbf{p_{jt}}) = 
\left[ \text{log} \left( \dfrac{p_{3jt}}{p_{5jt}} \right), 
\text{log} \left( \dfrac{p_{4jt}}{p_{5jt}} \right) \right] ^ \top
$$

has a hierarchical bivariate normal distribution with population-level random effects $\boldsymbol{\eta}^\text{pop}_{\mathbf{p}, j}$ and unique residuals $\boldsymbol{\epsilon}_{\mathbf{p}, jt}$:

$$
\begin{aligned}
\text{alr}(\mathbf{p_{jt}}) &= \text{alr}(\boldsymbol{\mu}_\mathbf{p}) + 
\boldsymbol{\eta}^\text{pop}_{\mathbf{p}, j} +
\boldsymbol{\epsilon}_{\mathbf{p}, jt} 
\\
\boldsymbol{\eta}^\text{pop}_{\mathbf{p}, j} &\sim 
N(\mathbf{0}, \boldsymbol{\Sigma}^\text{pop}_\mathbf{p}) 
\\
\boldsymbol{\epsilon}_{\mathbf{p}, jt} &\sim
N(\mathbf{0}, \boldsymbol{\Sigma}_\mathbf{p}).
\end{aligned}
$$

Here the 2 $\times$ 2 covariance matrices $\boldsymbol{\Sigma}^\text{pop}_\mathbf{p}$ and $\boldsymbol{\Sigma}_\mathbf{p}$ allow correlated variation among age classes (on the unconstrained scale, not merely due to the simplex constraint on $\mathbf{p}$) across populations and through time within a population, respectively. For example, some populations or cohorts may skew overall younger or older than average. We parameterize each covariance matrix by a vector of standard deviations and a correlation matrix: 

$$
\begin{aligned}
\boldsymbol{\Sigma}^\text{pop}_\mathbf{p} &= 
\boldsymbol{\sigma}^\text{pop}_\mathbf{p}
\mathbf{R}_\mathbf{p}^\text{pop} 
{ \boldsymbol{\sigma}^\text{pop}_\mathbf{p} } ^ \top
\\
\boldsymbol{\Sigma}_\mathbf{p} &= 
\boldsymbol{\sigma}_\mathbf{p} 
\mathbf{R}_\mathbf{p}
\boldsymbol{\sigma}_\mathbf{p} ^ \top .
\end{aligned}
$$

### Sex Structure

Adult sex structure is modeled as the conditional probability $p_{\text{F},jt}$ that an outmigrant from population $j$ in year $t$ is female, given that it survives to adulthood. The proportion of females follows a process model that includes normally distributed population-specific random effects $\eta^\text{pop}_{\text{F}}$ with hyper-SD $\sigma^\text{pop}_\text{F}$ and unique residuals $\epsilon^\text{pop}_{\text{F}}$ with SD $\sigma_\text{F}$ around the hyper-mean $\mu_\text{F}$.

$$
\begin{aligned}
\text{logit}( p_{\text{F},jt} ) &= \text{logit}( \mu_\text{F} ) + 
\eta^\text{pop}_{\text{F},j} + \epsilon_{\text{F},jt} 
\\
\eta^\text{pop}_{\text{F},j} &\sim 
N(0, \sigma^\text{pop}_\text{F}) 
\\
\epsilon_{\text{F},jt} &\sim N(0, \sigma_\text{F})
\end{aligned}
$$

### Adult Recruitment and Composition

Recruitment of wild-origin adult spawners $S_\text{W}$ is calculated by summing over the corresponding outmigrant cohorts and subtracting the number of spawners removed for hatchery broodstock or to spawning channels ($B_{jt}$, assumed known without error). Fishery mortality of Lower Columbia chum is thought to be minimal.

$$
S_{\text{W}, jt} = \left(\sum_{a=3}^{5} 
s_{MS,j,t-a} \hspace{0.1cm} p_{aj,t-a} \hspace{0.1cm} M_{j,t-a} \right) - B_{jt} =
\left(\sum_{a=3}^{5} \tilde{S}_{\text{W}, ajt} \right) - B_{jt}.
$$

The proportion of naturally spawning hatchery-origin adults is modeled as an independent parameter in each population and year when hatchery programs were operational in the basin or when observed origin-frequency data indicate hatchery spawners were present. That is, we do not include a process model linking $p_{\text{HOS},jt}$ to hatchery releases and returns, although this is planned as a component of future model development. Abundance of hatchery-origin spawners is then calculated as

$$
S_{\text{H},jt} = \dfrac{ S_{\text{W},jt} \hspace{0.1cm} p_{\text{HOS},jt} } 
{ (1 - p_{\text{HOS},jt}) }.
$$

Total spawner abundance is then 

$$
S_{jt} = S_{\text{W},jt} + S_{\text{H},jt} + S^\text{add}_{jt}
$$ 
where $S^\text{add}_{jt}$ is the number of spawners that returned to populations $i \neq j$ and were translocated into population $j$. This is only nonzero in the case of Duncan Channel.

Spawner age structure is given by $\mathbf{q}_{jt} = [q_{3jt}, q_{4jt}, q_{5jt}]$, where $q_{ajt} = \tilde{S}_{\text{W},ajt} / \sum_a{\tilde{S}_{\text{W},ajt}}$. Spawner sex structure is given by the age-weighted average of female proportions from the respective outmigrant cohorts: $q_{\text{F},jt} = \sum_{a} {q_{ajt} \hspace{0.1cm} p_{\text{F},j,t-a}}$.


## Observation Model

### Fecundity

We modeled observations of fecundity from individual female chum salmon collected at hatcheries. The observation likelihood for the fecundity of female $i$ of age $a$ is a zero-truncated normal with age-specific mean and SD:

$$ E_{a,i}^\text{obs} \sim N_+(\mu_{E,a}, \sigma_{E,a}). $$

### Smolt and Spawner Abundance

Empirical estimates of smolt and spawner abundance come from monitoring programs that use various sampling methods (e.g., rotary screw traps for outmigrants and weirs or mark-recapture for adults) and statistical models (e.g., the **BTSPAS** R package or other Bayesian time-series models) to produce a posterior distribution of the abundance of a given life-history stage in each population and year. These methods have previously been applied and their output summarized by the posterior mean and SD. We used the posterior moments of abundance to compute the log-mean $\mu_{K,jt}$ and log-SD $\tau_{K,jt}$ for each life stage $K$ assuming the posterior is lognormal, which appears to be reasonable in general. We then used the observation-model posteriors as informative priors on the corresponding state variables in the IPM.

One complication is that outmigrant monitoring sites do not always have a one-to-one correspondence with independent populations. Specifically, the smolt trap in the mainstem Grays River intercepts juveniles produced in the mainstem population itself as well as the upstream West Fork Grays River and Crazy Johnson Creek populations, the latter of which is also sampled with a dedicated trap. To make the states comparable to the observations, we defined a derived state $\tilde{M}_{jt}$ that is the sum of smolts produced in population $j$ and all upstream populations, assuming no mortality.

$$
\begin{aligned}
\text{log}(\tilde{M}_{jt}) &\sim N(\mu_{\tilde{M},jt}, \tau_{\tilde{M},jt})
\\
\text{log}(S_{jt}) &\sim N(\mu_{S,jt}, \tau_{S,jt}).
\end{aligned}
$$

The IPM framework naturally handles missing observations, but in some cases an estimate of the observation prior log-mean $\mu_{K,jt}$ was available while the observation error log-SD $\tau_{K,jt}$ was missing or unknown. These missing values were imputed within the IPM by fitting a lognormal hyperdistribution to the known log-SDs:

$$
\begin{aligned}
\text{log}(\tau_{M,ij}) &\sim N( \mu_{\tau_M},  \sigma_{\tau_M})
\\
\text{log}(\tau_{S,ij}) &\sim N( \mu_{\tau_S},  \sigma_{\tau_S}).
\end{aligned}
$$

### Spawner Age Composition

Spawner age-composition data are collected from scale samples in each population and year (the IPM framework naturally handles cases in which no age samples are available). Age frequencies of wild spawners $\mathbf{n}_{ajt}^\text{obs} = [n_{3jt}^\text{obs}, n_{4jt}^\text{obs}, n_{5jt}^\text{obs}] ^\top$ are assumed to follow a multinomial observation likelihood with expected proportions given by the true state:

$$
\mathbf{n}_{ajt}^\text{obs} \sim 
\text{Multinomial} \left(  \sum_{a=3}^5 n_{ajt}^\text{obs},
\mathbf{q}_{jt} \right).
$$

### Spawner Rearing Type

Frequencies of wild- and hatchery-origin spawners are estimated based on otolith marking or genetic parentage-based tagging (PBT), and are assumed to follow a binomial observation likelihood given the total sample size assigned to rearing origin:

$$
n_{\text{H},jt}^\text{obs} \sim 
\text{Bin} \left( n_{\text{W},jt}^\text{obs} + n_{\text{H},jt}^\text{obs},
p_{\text{HOS},jt} \right).
$$

### Spawner Sex Ratio

The observed frequency of female spawners is modeled with a binomial observation likelihood given the total sample size assigned to sex:

$$
n_{\text{F},jt}^\text{obs} \sim 
\text{Bin} \left( n_{\text{M},jt}^\text{obs} + n_{\text{F},jt}^\text{obs},
q_{\text{F},jt} \right).
$$


## Priors

To complete the model specification, we need priors on all top-level or hyperparameters as well as initial states that are not generated by the process model. In the list of parameter priors below, the power-exponential (also known as generalized normal or Subbotin) density

$$
\text{PowerExp}(x | u,s,r) = \dfrac{r}{2 s \Gamma(1/r)} 
\text{exp} \left[ - \left( \dfrac{|x - u|}{s} \right)^r \right]
$$

is used to regularize autocorrelation coefficients away from the computationally problematic boundaries 1 and -1. The Lewandowski, Kurowicka and Joe (2009) distribution with density $\text{LKJ}(\eta)$, is a distribution over correlation matrices; when $\eta = 1$ it is uniform. The prior mean and SD of log-mean smolt capacity, $m_{M_\text{max}}$ and $s_{M_\text{max}}$, are the sample 90th percentile and SD of observed log smolt density, respectively. While this data-aware prior technically uses the data twice, it is broad and weakly informative and merely serves to find a reasonable scale for overall population size, similar to [widely used Bayesian inference packages](https://cran.r-project.org/web/packages/rstanarm/vignettes/priors.html).

$$
\begin{aligned}
\mu_{E,a} &\sim N_+(2500,500) \\
\sigma_{E,a} &\sim N_+(500,1000) \\
\delta_{\text{NG}} &\sim U(0,1) \\
\mu_\psi &\sim U(0,1) \\
\sigma_\psi &\sim N_+(0,1) \\
\mu_{M_\text{max}} &\sim N(m_{M_\text{max}}, s_{M_\text{max}}) \\
\sigma_{M_\text{max}} &\sim N_+(0,3) \\
\rho_M &\sim \text{PowerExp}(0,0.85,20) \\
\sigma^\text{year}_M &\sim N_+(0,2) \\
\sigma_M &\sim N_+(0,2) \\
\mu_{MS} &\sim U(0,1) \\
\rho_{MS} &\sim \text{PowerExp}(0,0.85,20) \\
\sigma^\text{year}_{MS} &\sim N_+(0,2) \\
\sigma_{MS} &\sim N_+(0,2) \\
\boldsymbol{\sigma}^\text{pop}_\mathbf{p} &\sim N_+(0,2) \\
\boldsymbol{\sigma}_\mathbf{p} &\sim N_+(0,2) \\
\mathbf{R}_\mathbf{p}^\text{pop} &\sim \text{LKJ}(1) \\
\mathbf{R}_\mathbf{p} &\sim \text{LKJ}(1) \\
\mu_\text{F} &\sim U(0,1) \\
\sigma^\text{pop}_\text{F} &\sim N_+(0,2) \\
\sigma_\text{F} &\sim N_+(0,2) \\
\mu_{\tau_M} &\sim N(0,1) \\
\sigma_{\tau_M} &\sim N_+(0,5) \\
\mu_{\tau_S} &\sim N(0,1) \\
\sigma_{\tau_S} &\sim N_+(0,5)
\end{aligned}
$$

```{r prior_table, results="asis", echo=FALSE, include=FALSE}
## alternative presentation
prior_table <- read.csv(here("analysis","prior_table.csv"))
knitr::kable(prior_table, escape = FALSE)
```

Finally, lognormal priors on initial smolt abundance (in year 1 of each population time series) and spawner abundance (in years 1-3) are also data-aware but weakly informative, with parameters equal to the sample log-mean and 2 times the sample log-SD of observed abundance, respectively. The prior on spawner age composition in years 1-3 is simplex-uniform over the space of "orphan" age classes, i.e. those too old to have parent brood years included in the process model. The proportion of females in the same orphan age classes is given a $\text{Beta}(3,3)$ prior to weakly regularize toward an equal sex ratio.


# Data Structure

User inputs needed to fit the Lower Columbia chum IPM include, first, a data frame containing observations and associated information organized by population and year. We can look at the subset of rows of `fish_data_SMS` for the Crazy Johnson Creek population (coded `Grays CJ`) to see what column names and formats **salmonIPM** expects:

```{r print_fish_data_SMS, echo=FALSE}
library(kableExtra)
fish_data_SMS %>% select(-strata) %>% filter(pop %in% c("Grays CJ")) %>%
  kable(digits = replace(rep(0, ncol(.)), c(3,5,7), c(1,2,2))) %>% 
  column_spec(column = 1, width_min = "80px") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed")) %>% 
  scroll_box(width = "100%")
```
<br>
Column names generally follow the mathematical notation; `fit_p_HOS` is a logical or numeric variable indicating whether $p_{\text{HOS},jt}$ should be estimated or set to zero, and `downstream_trap` gives the row index corresponding to the downstream smolt trap that captures outmigrants from the given `pop` and `year`. (In this case, `Grays CJ` smolts are also counted at a local trap.)


Second, `fecundity_data` contains observations of individual fecundity indexed by hatchery female. Here are the first few rows (`year` and `ID` are not actually used in modeling):

```{r print_fecundity_data, echo=FALSE}
library(kableExtra)
fecundity_data %>% select(-strata) %>% head(10) %>% kable() %>% 
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = FALSE)
```

# Retrospective Models

## Model Fitting

We can now call the function `salmonIPM()` to fit models to the historical Lower Columbia chum monitoring data. Here we use the Ricker spawner-recruit function. This model takes approximately `r round(mean(rowSums(get_elapsed_time(LCRchum_Ricker)))/3600)` hr to fit on a multicore 3-GHz Intel processor.

```{r fit_LCRchum_Ricker, eval = !exists("LCRchum_Ricker")}
```

```{r print_LCRchum_Ricker}
```

The results (showing only hyperparameters for readability) suggest that the Markov chains mixed adequately, since the Gelman-Rubin $\widehat{R}$ diagnostics are all &leq; 1.01 and effective sample sizes $n_\text{eff}$ are sufficient for computing 90% credible intervals. We may get false-positive warnings that some $\widehat{R}$ and $n_\text{eff}$ estimates are `NaN`, but these are for fixed diagonal elements of correlation matrices. We could further explore the chains and HMC diagnostics using visualizations in the [**shinystan**](https://mc-stan.org/users/interfaces/shinystan) package. 

In principle we could fit all three spawner-recruit functions and compare them based on estimated out-of-sample predictive performance using the approximate leave-one-out cross-validation score ([LOO](http://mc-stan.org/loo/); Vehtari et al. 2017). In practice we find that LOO estimates for IPMs fitted to the Lower Columbia chum data are too unstable to be usable (excessive Pareto *k*-values indicating that some observations are highly influential on the posterior), requiring brute-force cross-validation or customized methods. These are under development, but in the meantime we proceed to use the Ricker model for inference since it is biologically plausible and fits the data reasonably well.

## Life-Cycle Parameters and States

The plot below summarizes posterior distributions of the main hyperparameters and states across the life cycle. In panels C-H, thick lines and shading correspond to the hyper-mean or ESU level and thin lines correspond to each of the 12 populations in the data set. In panels E-H, lines indicate posterior medians and shading indicates 90% posterior credible intervals at the ESU level (uncertainty around population-level curves is omitted for clarity). 

```{r multiplot_LCRchum_Ricker, echo=FALSE, warning=FALSE, fig.width=12, fig.height=5.5, out.width="100%"}
mod_name <- "LCRchum_Ricker"
<<multiplot>>
```

There is clear evidence of density-dependence, with more among-population heterogeneity in smolt capacity than in maximum egg-to-smolt survival, but most populations exhibit little if any overcompensation over the range of observed spawner densities (shown by the *x*-axis rug in E-F). Both freshwater productivity (total smolt process error, G) and SAR are strongly synchronous at the ESU scale. Freshwater productivity is relatively stable except for the sharp drop in 2019, the most recent year of available data. Smolt-to-adult survival, by contrast, shows strong and quasiperiodic fluctuations consistent with large-scale oceanographic or other environmental drivers. Because of this large and as-yet-unexplained process stochasticity, the uncertainty around the final 4 years of SAR estimates (corresponding to cohorts that have not yet fully returned as adults, and thus informed more by the process model than by data) is very wide.

We now examine model fits to data components in more detail.

## Fecundity

Fecundity was higher for 4- and 5-year old females than for the youngest age class. Here the histograms show observations and the lines and shading show the posterior median and 95% credible interval, respectively, of the estimated zero-truncated normal density, which fits the data reasonably well.

```{r plot_fecundity_fit_LCRchum_Ricker, echo=FALSE, fig.width=5, fig.height=5}
mod_name <- "LCRchum_Ricker"
<<plot_fecundity_fit>>
```

## Spawner Abundance

The next plot shows observed (observation-model posterior medians; points) and estimated spawner abundance for each population. Filled points indicate observations with known error SD (90% intervals are sometimes too narrow to be visible), while the SD for open points is imputed. The solid gray line is the posterior median of the true state from the IPM. Posterior 90% credible intervals indicate process (dark shading) and observation (light shading) uncertainty, i.e. the posterior predictive distribution (PPD) of hypothetical replicate data under the model. Leading or trailing years without spawner abundance estimates are included if smolt abundance is available.

```{r plot_spawners_LCRchum_Ricker, echo = FALSE, warning=FALSE, fig.width=11, fig.height=7, out.width="100%"}
life_stage <- "S"
<<plot_spawner_smolt_ts>>
show(gg)
```

## Smolt Abundance

Fits to the smolt abundance data, following the same conventions as for spawner abundance, immediately show how much sparser the juvenile sampling is. Only six populations are monitored with smolt traps (including `Grays WF`, which along with `Grays CJ` is incorporated into the summed smolt observations and estimates for the downstream `Grays MS` trap) and several of those time series are incomplete. For that reason, a greater share of the information about the underlying state comes from the process model, which induces synchronous fluctuations.

```{r plot_smolts_LCRchum_Ricker, echo = FALSE, warning=FALSE, fig.width=11, fig.height=7, out.width="100%"}
life_stage <- "M"
<<plot_spawner_smolt_ts>>
show(gg)
```

## Observation Error

To understand how the IPM imputes the abundance observation error SD in cases where it is not reported, we can plot the lognormal hyperdistribution (posterior median and 90% credible interval) fitted to the known SD values (histogram).

```{r plot_obs_error_fit_LCRchum_Ricker, echo = FALSE, fig.width = 6, fig.height = 8}
<<plot_obs_error_fit>>
```

## Spawner Age Composition

Next we compare the estimated true spawner age-frequencies (posterior median and 90% credible interval) to the observed sample proportions (with 90% binomial confidence interval). Age composition varies considerably across populations and through time, tracking fluctuations in cohort strength. The precision of the estimated states follows the sample size, with smaller samples giving relatively more weight to the hierarchical process model.

```{r plot_spawner_age_LCRchum_Ricker, echo = FALSE, warning=FALSE, fig.width=11, fig.height=7*11/12, out.width="100%"}
<<plot_spawner_age_ts>>
show(gg)
```

## Spawner Sex Ratio

Plots of the estimated adult sex ratio, following a similar format, likewise show strong interannual fluctuations and some systematic deviations from a 1:1 sex ratio across populations.

```{r plot_sex_ratio_ts_LCRchum_Ricker, echo = FALSE, warning=FALSE, fig.width=11, fig.height=7, out.width="100%"}
<<plot_sex_ratio_ts>>
show(gg)
```

## Spawner Rearing Type

Proportion of hatchery-origin spawners was generally low, with some very small samples that cannot definitively rule out higher $p_\text{HOS}$. In terminal years when spawner data are not yet available but hatcheries are known to be operating in the population, the estimates revert back to the independent $U(0,1)$ prior. This is not a problem, but will change if we are able to expand the process model to include hatchery releases and returns, which would generate predictions of $p_{\text{HOS},jt}$.

```{r plot_p_HOS_ts_LCRchum_Ricker, echo = FALSE, warning=FALSE, fig.width=11, fig.height=7, out.width="100%"}
<<plot_p_HOS_ts>>
show(gg)
```


# Reporting Metrics

[summary from GitHub Issues, many / most of which are shown in plots above]


# Next Steps

Relative to our broader model development goals, we continue to:

1. Include habitat and environmental drivers – Incorporate covariates (e.g., freshwater habitat quality, oceanographic factors) into the IPM to estimate effects on stage-specific productivity, capacity, or survival. To date, these include spawning habitat area and basic oceanographic indices (e.g., PDO). We also developed a general formula-based syntax for specifying covariate effects to make model fitting more flexible and user-friendly.

2. Model hatchery operations – We are in the process of expanding the IPM to include hatchery fry/smolt releases. This will allow jointly modeling wild and hatchery SAR, which will help to inform estimates of common trends and environmental covariate effects. Longer-term, we plan to explicitly model hatchery operations, i.e., broodstock transfers into hatchery or quasi-hatchery populations and fry production. Explicitly accounting for translocated adults was a necessary first step toward these goals.

3. Explore straying and spatial connectivity – Along with modeling hatchery releases and returns, we plan to model dispersal among populations using a straying matrix parameterized by inter-population distance (i.e., a dispersal kernel), estimated using origin data from hatcheries and spawning channels. This could potentially affect inferences about metapopulation viability and allow scenario analyses related to recolonization. Explicitly accounting for translocated adults was a necessary first step toward this goal.

4. Conduct scenario analyses – Use the parameterized IPM to evaluate life-cycle bottlenecks (i.e., sensitivity to specific vital rates) and to ask questions about monitoring design (e.g., data gaps and value of specific data types relative to their cost); prioritization of habitat restoration; effectiveness of supplementation; and potential rates of recolonization. As a first step, we have compiled a list of reporting metrics that are or could be estimated by the IPM; currently the model generates 11 out of 15 such metrics.


